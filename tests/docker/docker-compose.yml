version: '3.8'

services:
    # Local WordPress environment (source)
    wordpress-local:
        build:
            context: ./local
            dockerfile: Dockerfile
        container_name: movepress-local
        ports:
            - '8080:80'
        environment:
            WORDPRESS_DB_HOST: mysql-local:3306
            WORDPRESS_DB_NAME: wordpress_local
            WORDPRESS_DB_USER: wordpress
            WORDPRESS_DB_PASSWORD: wordpress
        volumes:
            - ./local/entrypoint.sh:/usr/local/bin/custom-entrypoint.sh
            - ./movefile.yml:/var/www/html/movefile.yml:ro
            - ./ssh:/root/.ssh:ro
            - ../../build/movepress.phar:/usr/local/bin/movepress:ro
        networks:
            - movepress-test
        depends_on:
            mysql-local:
                condition: service_healthy
        entrypoint: /usr/local/bin/custom-entrypoint.sh

    # Local MariaDB database
    mysql-local:
        image: mariadb:latest
        container_name: movepress-mysql-local
        ports:
            - '3306:3306'
        environment:
            MYSQL_ROOT_PASSWORD: root
            MYSQL_DATABASE: wordpress_local
            MYSQL_USER: wordpress
            MYSQL_PASSWORD: wordpress
        networks:
            - movepress-test
        healthcheck:
            test: ['CMD', 'healthcheck.sh', '--connect', '--innodb_initialized']
            interval: 5s
            timeout: 5s
            retries: 10

    # Remote WordPress environment (destination)
    wordpress-remote:
        build:
            context: ./remote
            dockerfile: Dockerfile
        container_name: movepress-remote
        ports:
            - '8081:80'
            - '2222:22'
        environment:
            WORDPRESS_DB_HOST: mysql-remote:3306
            WORDPRESS_DB_NAME: wordpress_remote
            WORDPRESS_DB_USER: wordpress
            WORDPRESS_DB_PASSWORD: wordpress
        volumes:
            - ./remote/entrypoint.sh:/usr/local/bin/custom-entrypoint.sh
            - ./ssh:/root/.ssh
            - ../../build/movepress.phar:/usr/local/bin/movepress
        networks:
            - movepress-test
        depends_on:
            mysql-remote:
                condition: service_healthy
        entrypoint: /usr/local/bin/custom-entrypoint.sh

    # Remote MariaDB database
    mysql-remote:
        image: mariadb:latest
        container_name: movepress-mysql-remote
        ports:
            - '3307:3306'
        environment:
            MYSQL_ROOT_PASSWORD: root
            MYSQL_DATABASE: wordpress_remote
            MYSQL_USER: wordpress
            MYSQL_PASSWORD: wordpress
        networks:
            - movepress-test
        healthcheck:
            test: ['CMD', 'healthcheck.sh', '--connect', '--innodb_initialized']
            interval: 5s
            timeout: 5s
            retries: 10

networks:
    movepress-test:
        driver: bridge
